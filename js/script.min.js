/* Write JavaScript here */
function getInvoice(e){console.log("Flushing"),simpleStorage.flush()
var t=e.params.id
t&&(idExists=!0),loadFromMongo(t),renderButtons(),document.title="Invoice",$("meta[name=robots]").attr("content","noindex")}function main(){console.log("main page"),renderButtons()}function connect(){console.log("Connect"),window.location.href=baseURL}function renderButtons(){if($("#stripeButtons").show(),"true"==simpleStorage.get("paid")){$("#stripeButtonSpan").hide(),$("#connectButtonSpan").hide(),months=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],timestamp=simpleStorage.get("paymentDate")
var e=new Date(1e3*timestamp)
$("#paidButton").html('<i class="fa fa-check-circle"></i>  Paid on '+months[e.getMonth()]+" "+e.getDate()+" "+e.getFullYear()),$(".invDue").css("color","#CCCCCC"),$("#paidButtonSpan").show(),$("#stripeButtons").show()}else""==simpleStorage.get("spk")||void 0==simpleStorage.get("spk")?(console.log("Show Connect Button"),$("#stripeButtonSpan").hide(),$("#paidButtonSpan").hide(),$("#connectButtonSpan").show(),$("#stripeButtons").show(),idExists&&(console.log("Hide Connect Button"),$("#stripeButtons").hide())):(console.log("Show Pay Button"),$("#connectButtonSpan").hide(),$("#paidButtonSpan").hide(),$("#stripeButtonSpan").show(),$("#stripeButtons").show())}function about(){console.log("about page")}function clearInvoice(){console.log("flushing"),simpleStorage.flush(),window.location.href=baseURL}function loadData(e){if(simpleStorage.get(e)){var t=simpleStorage.get(e),o=$.parseHTML(t)
$("#"+e).html(o)}}function addNewRow(){console.log("adding row"),console.log("rowCount "+rowCount),rowCount++
var e=document.createElement("div")
e=$("#"+(rowCount-1)).clone(),e.attr("id",rowCount),e.appendTo($(".rowItemContainer")),$("#"+rowCount).find("#itemDesc"+(rowCount-1)).attr("id","itemDesc"+rowCount),$("#"+rowCount).find("#itemHour"+(rowCount-1)).attr("id","itemHour"+rowCount),$("#"+rowCount).find("#itemPrice"+(rowCount-1)).attr("id","itemPrice"+rowCount),$("#"+rowCount).find("#itemSum"+(rowCount-1)).attr("id","itemSum"+rowCount),$("#"+rowCount).find("#delete"+(rowCount-1)).attr("id","delete"+rowCount),$("#itemDesc"+rowCount).html(""),$("#itemHour"+rowCount).text(""),$("#itemPrice"+rowCount).text(""),$("#itemSum"+rowCount).text(""),$("#itemHour"+rowCount).numeric({negative:!1}),$("#itemPrice"+rowCount).numeric({negative:!1}),$("#delete"+(rowCount-1)).show(),$("#delete"+rowCount).hide()}function saveTable(){for(var e=1;e<=rowCount;e++)$("#"+e).length?(simpleStorage.set("itemDesc"+e,$("#itemDesc"+e).html()),simpleStorage.set("itemHour"+e,$("#itemHour"+e).text()),simpleStorage.set("itemPrice"+e,$("#itemPrice"+e).text())):(simpleStorage.deleteKey("itemDesc"+e),simpleStorage.deleteKey("itemHour"+e),simpleStorage.deleteKey("itemPrice"+e))
simpleStorage.set("rowCount",rowCount)}function loadTable(e){console.log("loading table of "+e+rowCount)
for(var t=1;t<=e;t++){var o=simpleStorage.get("itemDesc"+t),n=simpleStorage.get("itemHour"+t),a=simpleStorage.get("itemPrice"+t)
$("#itemDesc"+t).html(o),$("#itemHour"+t).text(n),$("#itemPrice"+t).text(a),(o||n||a)&&addNewRow()}}function isRowEmpty(e){var t=$("#itemDesc"+e).html().length,o=$("#itemHour"+e).text().length,n=$("#itemPrice"+e).text().length
return t+o+n<=0}function renderTable(){console.log("rendering table")
var e=0,t=0,o=0,n=.01*$("#vatp").text()
currency=$("#currency").text()
for(var a=1;a<=rowCount;a++){var i="#"+a
if($(i).length){var r=($("#itemDesc"+a).html(),$("#itemHour"+a).text()),s=$("#itemPrice"+a).text(),l=r*s
$("#itemSum"+a).text(currency+l.toFixed(2)),$("#subtotal").text(currency+(e+=l).toFixed(2)),$("#vat").text(currency+(t=e*n).toFixed(2)),$("#total").text(currency+(o=e+t).toFixed(2)),$("#invTotal").text(currency+(o=e+t).toFixed(2)),$("#invTotal_p").text((o=e+t).toFixed(2))}}isRowEmpty(rowCount)||addNewRow(),saveTable()}function deleteRow(e){console.log("deleting row")
var e=e.parent().parent().parent()
e.remove(),saveTable(),renderTable()}function saveData(e){var t=e.attr("id"),o=e.html(),n=e.text()
switch(t){case"invDateTop":$("#invDate").text(n),simpleStorage.set(t,n),simpleStorage.set("invDate",n)
break
case"invDate":$("#invDateTop").text(n),simpleStorage.set(t,n),simpleStorage.set("invDataTop",n)
break
case"dueDateTop":$("#dueDate").text(n),simpleStorage.set(t,n),simpleStorage.set("dueDate",n)
break
case"invToTop":$("#invTo").html(n),simpleStorage.set(t,n),simpleStorage.set("invTo",n)
break
case"invTo":$("#invToTop").html(n),simpleStorage.set(t,n),simpleStorage.set("invToTop",n)
break
case"dueDate":$("#dueDateTop").text(n),simpleStorage.set(t,n),simpleStorage.set("invDataTop",n)
break
default:$("#"+t).html(o),simpleStorage.set(t,o)}}function saveToMongo(e){console.log("Saving to Mongo")
for(var t="false",o={},n=0;n<staticDataFields.length;n++)o[staticDataFields[n]]=$("#"+staticDataFields[n]).html()
for(var a=$("#invTotal_p").text(),i=$("#currency").text(),r=simpleStorage.get("rowCount"),s=[],l=[],u=[],n=1;n<=parseInt(r);n++)s.push(simpleStorage.get("itemDesc"+n)),l.push(simpleStorage.get("itemHour"+n)),u.push(simpleStorage.get("itemPrice"+n))
var c,d,p
if(""!=simpleStorage.get("spk")&&""!=simpleStorage.get("at")){c=simpleStorage.get("spk"),d=simpleStorage.get("at"),p=simpleStorage.get("su")
var m={type:"create",paid:t,staticData:o,desc:s,hour:l,price:u,totalPrice:a,currency:i,rowCount:r,spk:c,at:d,su:p}}else var m={type:"create",paid:t,staticData:o,desc:s,hour:l,price:u,totalPrice:a,currency:i,rowCount:r}
$.ajax({type:"POST",url:baseURL+"/api.php",datatype:"JSON",data:m,success:function(t){console.log(t)
var o=JSON.parse(t)
if(o.invId){if(console.log(o.invId),invoiceID=o.invId,"send"==e)return sendMail(o.invId),o.invId
window.location.href=baseURL+"/"+o.invId}},error:function(e,t){console.log("Error")}})}function loadFromMongo(e){console.log("loading From Mongo")
var t={type:"get",invID:e.toString()}
$.ajax({type:"POST",url:baseURL+"/api.php",datatype:"JSON",data:t,success:function(e){if(console.log(e),e){var t=JSON.parse(e)
rowCount=t.rowCount
for(var o=0;o<staticDataFields.length;o++){var n=staticDataFields[o],a=t[n]
simpleStorage.set(n,a),$("#"+n).removeAttr("contenteditable"),loadData(n)}for(var o=1;o<rowCount;o++){console.log(rowCount)
var i=t["itemDesc"+o],r=t["itemHour"+o],s=t["itemPrice"+o]
simpleStorage.set("itemDesc"+o,i),simpleStorage.set("itemHour"+o,r),simpleStorage.set("itemPrice"+o,s),$("#itemDesc"+o).removeAttr("contenteditable"),$("#itemHour"+o).removeAttr("contenteditable"),$("#itemPrice"+o).removeAttr("contenteditable")}console.log("Setting SPK from Mongo"),simpleStorage.set("spk",t.spk)
var l=rowCount
rowCount>1&&(rowCount=1,loadTable(l),console.log("rowCount after loading table: "+rowCount),renderTable(),console.log("rowCount after rendering table: "+rowCount))
for(var o=1;o<rowCount;o++)$("#delete"+o).remove()
switch($("#itemDesc"+o).removeAttr("contenteditable"),$("#itemHour"+o).removeAttr("contenteditable"),$("#itemPrice"+o).removeAttr("contenteditable"),$("#vatp").removeAttr("contenteditable"),$("#currency").removeAttr("contenteditable"),$("#"+rowCount).remove(),$("#menuSendInvoice").remove(),$("#menuGenerateInvoice").remove(),renderButtons(),flag=!0,console.log("currency-2 -> "+currency),currency){case"$":invCurr="usd",console.log("invCurr -> usd")
break
case"€":invCurr="eur",console.log("invCurr -> eur")
break
case"£":invCurr="gbp",console.log("invCurr -> gbp")
break
default:invCurr=""}}},error:function(e,t){console.log("ID NOT FOUND")}})}function prepareSendView(){var e='<p>Hi <span class="textHighlight">there</span>,</p><br/><p>Was pleasure working with you on <span class="textHighlight">'+$("#invFor").html()+'</span>. Appreciate your business and timely payment.</p><br/><p class="invLink" id="invLink">(The invoice link will be here)</p><br/><p>Sincerely,</p><p id="senderName"><span class="textHighlight">Jack Smith</span></p>'
$("#emailBody").html(e)}function sendMail(e){var t=$("#sendFrom").val(),o=$("#sendTo").val(),n="You've got invoice!",a=prepareEmailBody($("#emailBody").html().trim()),i={from_email:t,mailTo:o,mailFrom:t,mailSubject:n,mailBody:a}
console.log("Sending"),$.ajax({type:"POST",url:baseURL+"/sendmail.php",context:document.body,data:i,success:function(n){if(console.log(n),n){console.log("Message Sent")
var a={type:"save_email",invId:e,senderEmail:t,receiverEmail:o}
console.log("Save Emails to mongo"),$.ajax({type:"POST",url:baseURL+"/api.php",datatype:"JSON",data:a,success:function(t){console.log(t),t&&(console.log("Email Saved"),window.location.href=baseURL+"/"+e)},error:function(){console.log("Mail send Error"),alert("Mail send Error")}})}},error:function(){console.log("Mail send Error"),alert("Mail send Error")}})}function sendSummary(){$(".sendButton").magnificPopup({closeBtnInside:!0}),$("#sendButton").click(function(){$("#sendSummary").click()})}function sendInvoice(){var e=$("#sendFrom").val(),t=$("#sendTo").val()
$("#emailBody").html()
$("#sendButton").prop("disabled",!0),isValidEmailAddress(e)&&isValidEmailAddress(t)&&""!=$("#emailBody").text()?invoiceID=saveToMongo("send"):(shake($("#sendPopup")),validateField($("#sendFrom")),validateField($("#sendTo"))),$("#sendButton").prop("disabled",!1)}function prepareEmailBody(e){for(var t=$("<div>"+e.trim()+"</div>"),o=$(t).find("p"),n="",a=0;a<o.length;a++)if("invLink"==$(o[a]).attr("id")){var i=baseURL+"/"+invoiceID
n+=i}else{var r="<p>"+$(o[a]).text()+"</p>"
n+=r}return n}function printInvoice(){console.log("hiding"),$(".menu-wrap").hide(),console.log("hiding"),$(".menu-button").hide(),$(".invBody").css({"min-width":"0"}),$(".invBody").css({width:"90%"}),$(".invContainer").css({margin:"20px auto 10px auto"}),setTimeout(function(){window.print()},1e3),$(".menu-wrap").show(),$(".menu-button").show()}function charge(){console.log("Charge")}function getToday(e){var t=new Date
t.setDate(t.getDate()+e)
var o=t.getDate(),n=t.getMonth()+1,a=t.getFullYear()
switch(n<10&&(n="0"+n),n){case"01":n="Jan"
break
case"02":n="Feb"
break
case"03":n="Mar"
break
case"04":n="Apr"
break
case"05":n="May"
break
case"06":n="Jun"
break
case"07":n="Jul"
break
case"08":n="Aug"
break
case"09":n="Sep"
break
case"10":n="Oct"
break
case"11":n="Nov"
break
case"12":n="Dec"}return t=n+" "+o+", "+a}function isValidEmailAddress(e){var t=new RegExp(/^((([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+(\.([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+)*)|((\x22)((((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(([\x01-\x08\x0b\x0c\x0e-\x1f\x7f]|\x21|[\x23-\x5b]|[\x5d-\x7e]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(\\([\x01-\x09\x0b\x0c\x0d-\x7f]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]))))*(((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(\x22)))@((([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.)+(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.?$/i)
return t.test(e)}function shake(e){TweenMax.fromTo(e,.01,{x:-2},{x:2,clearProps:"x",repeat:20})}function validateField(e){isValidEmailAddress(e.val())?(e.addClass("inputField"),e.removeClass("inputFieldError")):(e.removeClass("inputField"),e.addClass("inputFieldError"),shake(e))}var currency=$("#currency").text(),baseURL=window.location.origin,invoiceID,flag=!1,idExists=!1,invCurr
document.write('<style type="text/css">body{display:none}</style>'),jQuery(function(e){e("body").css("display","block")})
var rowCount=simpleStorage.get("rowCount")
if(!rowCount)var rowCount=1
var staticDataFields=["invBy","invDateTop","invDate","invToTop","invTo","invFor","invByName","invNumber","dueDateTop","dueDate","invRef","payDetails","invTerms","paid","paymentDate","currency","vatp"]
$(document).ready(function(){$("#delete1").hide(),page("/about",about),page("",main),page("/index.php",main),page("/stripe_connect.php",main),page("/charge.php",charge),page("/:id",getInvoice),page(),simpleStorage.get("#invDateTop")||$("#invDateTop").html(getToday(0)),simpleStorage.get("#dueDateTop")||$("#dueDateTop").html(getToday(14)),simpleStorage.get("#invDate")||$("#invDate").html(getToday(0)),simpleStorage.get("#dueDate")||$("#dueDate").html(getToday(14))
for(var e=0;e<staticDataFields.length;e++)loadData(staticDataFields[e])
var t=rowCount
rowCount>1&&(rowCount=1,loadTable(t)),renderTable(),$(".openPopupLink").magnificPopup({type:"inline",mainClass:"mfp-fade",overflowY:"scroll",callbacks:{open:function(){$.magnificPopup.instance.close=function(){$.magnificPopup.proto.close.call(this)}}}}),$(".textHighlight").on("click",function(){$(this).removeClass()}),$("#itemHour1").numeric({negative:!1}),$("#itemPrice1").numeric({negative:!1}),$("#invByName").focus(),console.log("currency-1 -> "+currency),console.log("currency-1 -> "+currency)}),window.onbeforeunload=function(){}
