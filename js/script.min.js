function ApplicationController(e,n){function i(){var e=document.body
classie.has(e,"show-menu")?classie.remove(e,"show-menu"):classie.add(e,"show-menu")}function t(){e.stripeButtonVisible=!0}function o(){t()}function r(){t()}function a(e){t(),simpleStorage.flush(),document.title="Invoice",p.invoice_id=e.params.id,$("meta[name=robots]").attr("content","noindex")}var c=document.body,u=(document.querySelector(".content-wrap"),document.getElementById("open-button")),s=document.getElementById("close-button")
u.addEventListener("click",i),s&&s.addEventListener("click",i),$("#icon-list").children().each(function(){$(this).click(function(){i()})}),c.addEventListener("click",function(e){var n=e.target
classie.has(c,"show-menu")&&n!==u&&i()})
var p=this
page("",t),page("/about",o),page("/index.php",t),page("/stripe_connect.php",t),page("/charge.php",r),page("/:id",a),page(),e.clearInvoice=function(){simpleStorage.flush(),window.location.href=baseURL},e.printInvoice=function(){setTimeout(function(){window.print()},1e3)}}function InvoiceDirective(e){return{restrict:"EC",scope:{},controller:"InvoiceController",controllerAs:"ctrl",templateUrl:function(){return e+"/invoice.html"},bindToController:{invoice_id:"="},link:function(){$("#invByName").focus()}}}function InvoiceController(e,n,i,t,o,r){function a(e){TweenMax.fromTo(e,.01,{x:-2},{x:2,clearProps:"x",repeat:20})}function c(e){var n=new RegExp(/^((([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+(\.([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+)*)|((\x22)((((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(([\x01-\x08\x0b\x0c\x0e-\x1f\x7f]|\x21|[\x23-\x5b]|[\x5d-\x7e]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(\\([\x01-\x09\x0b\x0c\x0d-\x7f]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]))))*(((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(\x22)))@((([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.)+(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.?$/i)
return n.test(e)}function u(e){for(var n=$("<div>"+e.trim()+"</div>"),i=$(n).find("p"),t="",o=0;o<i.length;o++)if("invLink"==$(i[o]).attr("id")){var r=baseURL+invoiceID
t+=r}else{var a="<p>"+$(i[o]).text()+"</p>"
t+=a}return t}var s=this,p=n("date")(new Date,"mediumDate"),l=n("date")((new Date).addDays(i.dueDays),"mediumDate")
e.invoice={items:[],currency:i.currency,invNumber:"",invBy:"",invByName:"",invDate:p,invTo:"",invFor:"",invRef:"",invTerms:"",dueDate:l,paymentDate:"",payDetails:"",vatp:i.vatp,paid:!1,stripe:{spk:"",at:"",su:""}},e.$watch("ctrl.invoice_id",function(n){"undefined"==typeof n?(s.loadFromLocal(),window.hasOwnProperty("stripe_spk")&&(e.invoice.stripe={spk:stripe_spk,at:stripe_at,su:stripe_su})):s.loadFromMongo(),e.currency=e.invoice.currency}),e.$watch("invoice",function(){0==s.hasEmptyRow()&&e.addItem(),s.saveToLocal(),$(".unit, .price").numeric({negative:!1})},!0),e.$watch("currency",function(n){var i=n.toString().toLowerCase()
t.hasOwnProperty(i)&&(e.invoice.currency=i)}),e.email={from:"",to:"",body:"<p>Hi there,</p><br/><p>Was pleasure working with you on "+e.invoice.invFor+'. Appreciate your business and timely payment.</p><br/><p class="invLink" id="invLink">(The invoice link will be here)</p><br/><p>Sincerely,</p><p id="senderName">Jack Smith</p>'},e.addItem=function(){e.invoice.items.push({description:"",unit:"",price:""})},e.deleteItem=function(n){e.invoice.items.splice(n,1)},s.loadFromLocal=function(){var n="invoice"
simpleStorage.hasKey(n)&&(e.invoice=simpleStorage.get(n))},s.loadFromMongo=function(){var n=angular.toJson({type:"get",invID:s.invoice_id})
o.save({},n,function(n){var i=JSON.parse(n)
e.invoice={items:[],currency:i.currency,invNumber:i.invNumber,invBy:i.invBy,invByName:i.invByName,invDate:i.invDate,invTo:i.invTo,invFor:i.invFor,invRef:i.invRef,invTerms:i.invTerms,dueDate:i.dueDate,paymentDate:i.paymentDate,payDetails:i.payDetails,vatp:i.vatp,paid:i.paid,stripe:{spk:i.spk,at:i.at,su:i.su}}
var t=function(e){return"itemDesc"===e.toString().substr(0,4)},o=Object.getOwnPropertyNames(i).filter(t).sort()
angular.forEach(o,function(n){e.invoice.items.push({description:i[n],unit:i[n.replace("Desc","Hour")],price:i[n.replace("Desc","Price")]})}),$("#menuSendInvoice").remove(),$("#menuGenerateInvoice").remove(),$(".delete-btn").hide(),$("[contenteditable]").removeAttr("contenteditable")},function(e){console.log("Error",e)})},s.saveToLocal=function(){simpleStorage.set("invoice",e.invoice)},s.saveToMongo=function(n){var i=[],t=[],r=[]
angular.forEach(e.invoice.items,function(e){i.push(e.description),t.push(e.unit),r.push(e.price)})
var a=angular.toJson({type:"create",paid:e.invoice.paid,staticData:e.invoice,desc:i,hour:t,price:r,totalPrice:e.total(),currency:e.invoice.currency,spk:e.invoice.stripe.spk,at:e.invoice.stripe.at,su:e.invoice.stripe.su})
o.save({},a,function(e){var i=JSON.parse(e)
i.invId?(s.invoice_id=i.invId,"send"==n?s.sendMail():window.location.href=baseURL+s.invoice_id):console.log("Missing invoice ID")},function(e){console.log("Error",e)})},s.hasEmptyRow=function(){if(0==e.invoice.items.length)return!1
var n=!1
return!!e.invoice.items.reduce(function(e,n){return e||!n.description&&!n.unit&&!n.price},n)},e.subtotal=function(){return e.invoice.items.reduce(function(e,n){return e+n.unit*n.price},0)},e.vat=function(){return e.subtotal()*e.invoice.vatp/100},e.total=function(){return e.subtotal()+e.vat()},e.connectStripe=function(){window.location.href="https://connect.stripe.com/oauth/authorize?response_type=code&client_id=ca_5atlLM2xPkC35t8Inzy9niMkIUJqYUuN&scope=read_write&state=1234"},e.payStripe=function(){var n=$("#charge-form"),i=function(e){n.append($("<input>").attr({type:"hidden",name:"stripeToken",value:e.id})).submit()}
StripeCheckout.open({key:e.invoice.stripe.spk,amount:100*e.total(),currency:e.invoice.currency,name:"INVOICE",description:e.invoice.invByName,panelLabel:"Pay Now ",token:i})},e.sendInvoice=function(){$("#sendButton").prop("disabled",!0),c(e.email.from)&&c(e.email.to)&&""!=e.email.body?s.saveToMongo("send"):(a($("#sendPopup")),e.validateField($("#sendFrom")),e.validateField($("#sendTo"))),$("#sendButton").prop("disabled",!1)},e.validateField=function(e){c(e.val())?(e.addClass("inputField"),e.removeClass("inputFieldError")):(e.removeClass("inputField"),e.addClass("inputFieldError"),a(e))},s.sendMail=function(){var n="You've got invoice!",i=u(e.email.body),t=angular.toJson({from_email:e.email.from,mailTo:e.email.to,mailFrom:e.email.from,mailSubject:n,mailBody:i})
r.save({},t,function(n){var i=angular.toJson({type:"save_email",invId:s.invoice_id,senderEmail:e.email.from,receiverEmail:e.email.to})
o.save({},i,function(e){window.location.href=baseURL+s.invoice_id},function(e){console.log("Error",e)})},function(e){console.log("Error",e)})}}function DirectiveOpenPopupLink(){return{restrict:"C",link:function(e,n){n.magnificPopup({callbacks:{close:function(){$(".menu-wrap").hide(),setTimeout(function(){$(".menu-wrap").show()},100)}}})}}}var baseURL=window.location.protocol+"//"+window.location.host+"/",invoiceID,app=angular.module("Application",["ngResource"])
app.value("currencyCodes",{eur:"€",usd:"$",gbp:"£"}),app.value("config",{currency:"usd",dueDays:14,vatp:10}),app.value("templateBase","js/views"),app.directive("contenteditable",function(){return{restrict:"A",require:"ngModel",link:function(e,n,i,t){function o(){t.$setViewValue(n.html())}t.$render=function(){n.html(t.$viewValue||"")},n.bind("blur keyup change",function(){e.$apply(o)})}}}),app.factory("Api",function(e){var n=baseURL+"api.php"
return e(n)}),app.factory("Sendmail",function(e){var n=baseURL+"sendmail.php"
return e(n)}),app.filter("currency",function(e){return function(n,i){var t=n.toFixed(2)
return e.hasOwnProperty(i)?e[i]+t:t}}),app.controller("ApplicationController",ApplicationController),ApplicationController.$inject=["$scope","currencyCodes"],app.directive("invoice",InvoiceDirective),InvoiceDirective.$inject=["templateBase"],app.controller("InvoiceController",InvoiceController),InvoiceController.$inject=["$scope","$filter","config","currencyCodes","Api","Sendmail"],app.directive("openPopupLink",DirectiveOpenPopupLink),Date.prototype.addDays=function(e){var n=new Date(this.valueOf())
return n.setDate(n.getDate()+e),n}
